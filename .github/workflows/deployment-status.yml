on:
  push:
    branches: [ main ]

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      deployment_issue_number: ${{ steps.create_issue.outputs.issue_number }}
      previous_commit: ${{ steps.get_commits.outputs.previous_commit }}
      current_commit: ${{ steps.get_commits.outputs.current_commit }}
      package_version: ${{ steps.get_version.outputs.package_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Get commit SHAs
        id: get_commits
        run: |
          echo "current_commit=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "previous_commit=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT

      - name: Get package version
        id: get_version
        run: |
          PACKAGE_VERSION=$(jq -r '.version' package.json)
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT

      - name: Create deployment tracking issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const currentCommit = '${{ steps.get_commits.outputs.current_commit }}';
            const title = `Deployment Tracking - ${currentCommit}`;
            const labels = ['deployment', 'in-progress'];
            
            const issue = await github.rest.issues.create({
              owner,
              repo,
              title,
              labels
            });
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.data.number,
              body: 'Pre-deployment checks completed'
            });
            
            return issue.data.number;

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    outputs:
      artifact_name: ${{ steps.create_artifacts.outputs.artifact_name }}
      sha256_checksum: ${{ steps.create_artifacts.outputs.sha256_checksum }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create rollback artifacts
        id: create_artifacts
        run: |
          CURRENT_COMMIT=${{ needs.pre-deployment.outputs.current_commit }}
          PREVIOUS_COMMIT=${{ needs.pre-deployment.outputs.previous_commit }}
          PACKAGE_VERSION=${{ needs.pre-deployment.outputs.package_version }}
          ARTIFACT_NAME="rollback-package-${CURRENT_COMMIT}"
          
          cat > rollback.sh << EOF
          #!/bin/bash
          set -euo pipefail
          
          echo "Initiating rollback to commit ${PREVIOUS_COMMIT}..."
          
          git checkout ${PREVIOUS_COMMIT} || { echo "Failed to checkout previous commit"; exit 1; }
          npm ci || { echo "Failed to install dependencies"; exit 1; }
          npm run verify-dependencies || { echo "Dependency verification failed"; exit 1; }
          
          echo "Rollback completed successfully to ${PREVIOUS_COMMIT}!"
          EOF
          chmod +x rollback.sh
          
          cat > verify-dependencies.sh << EOF
          #!/bin/bash
          set -euo pipefail
          
          echo "Verifying dependencies compatibility..."
          
          npm ls || { echo "Dependency tree has issues"; exit 1; }
          
          REQUIRED_NODE_VERSION=$(jq -r '.engines.node' package.json)
          CURRENT_NODE_VERSION=$(node -v)
          if ! npx semver -r "$REQUIRED_NODE_VERSION" "$CURRENT_NODE_VERSION"; then
            echo "Node.js version $CURRENT_NODE_VERSION does not satisfy $REQUIRED_NODE_VERSION"
            exit 1
          fi
          
          echo "Dependencies verified successfully!"
          EOF
          chmod +x verify-dependencies.sh
          
          cat > rollback-documentation.md << EOF
          # Rollback Documentation for Deployment ${CURRENT_COMMIT}
          
          ## Step-by-Step Rollback Instructions
          1. Download the rollback package artifact
          2. Extract the package: unzip ${ARTIFACT_NAME}.zip
          3. Navigate to the extracted directory: cd ${ARTIFACT_NAME}
          4. Make scripts executable: chmod +x rollback.sh verify-dependencies.sh
          5. Run the rollback script: ./rollback.sh
          
          ## Important Information
          - Previous Commit: ${PREVIOUS_COMMIT}
          - Current Commit: ${CURRENT_COMMIT}
          - Package Version: ${PACKAGE_VERSION}
          - Artifact Checksum: [To be filled]
          
          ## Verification Steps
          After rollback:
          1. Verify application is running: npm start
          2. Run tests: npm test
          3. Check logs for any errors
          EOF
          
          mkdir -p backups
          cp package.json backups/
          cp package-lock.json backups/
          
          mkdir -p ${ARTIFACT_NAME}
          cp rollback.sh ${ARTIFACT_NAME}/
          cp verify-dependencies.sh ${ARTIFACT_NAME}/
          cp rollback-documentation.md ${ARTIFACT_NAME}/
          cp -r backups ${ARTIFACT_NAME}/
          zip -r ${ARTIFACT_NAME}.zip ${ARTIFACT_NAME}/
          
          SHA256_CHECKSUM=$(sha256sum ${ARTIFACT_NAME}.zip | awk '{print $1}')
          
          sed -i "s/\[To be filled\]/${SHA256_CHECKSUM}/" ${ARTIFACT_NAME}/rollback-documentation.md
          zip -r ${ARTIFACT_NAME}.zip ${ARTIFACT_NAME}/rollback-documentation.md
          
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "sha256_checksum=${SHA256_CHECKSUM}" >> $GITHUB_OUTPUT

      - name: Upload rollback artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.create_artifacts.outputs.artifact_name }}
          path: ${{ steps.create_artifacts.outputs.artifact_name }}.zip
          retention-days: 30
          if-no-files-found: error

      - name: Post rollback plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = ${{ needs.pre-deployment.outputs.deployment_issue_number }};
            const previousCommit = '${{ needs.pre-deployment.outputs.previous_commit }}';
            const currentCommit = '${{ needs.pre-deployment.outputs.current_commit }}';
            const packageVersion = '${{ needs.pre-deployment.outputs.package_version }}';
            const artifactName = '${{ steps.create_artifacts.outputs.artifact_name }}';
            const sha256Checksum = '${{ steps.create_artifacts.outputs.sha256_checksum }}';
            
            const commentBody = `## ðŸ”„ Rollback Plan Ready
            
            - Previous Commit: ${previousCommit}
            - Current Commit: ${currentCommit}
            - Package Version: ${packageVersion}
            - Artifact: ${artifactName}
            
            ### Completed Rollback Components
            âœ… Rollback script created
            âœ… Configuration backup (package.json, package-lock.json)
            âœ… Dependency verification script
            âœ… Detailed rollback documentation
            âœ… Compressed rollback package with SHA256 checksum
            
            ### Quick Rollback Command
            \`\`\`bash
            # Download and extract artifact
            unzip ${artifactName}.zip
            cd ${artifactName}
            chmod +x rollback.sh
            ./rollback.sh
            \`\`\`
            
            - Rollback script created: true
            - Configuration backup: true
            - SHA256: ${sha256Checksum}`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: commentBody
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: rollback-preparation
    steps:
      - name: Update deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = ${{ needs.pre-deployment.outputs.deployment_issue_number }};
            const artifactName = '${{ needs.rollback-preparation.outputs.artifact_name }}';
            const sha256Checksum = '${{ needs.rollback-preparation.outputs.sha256_checksum }}';
            
            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });
            
            const currentLabels = issue.data.labels.map(label => label.name);
            const newLabels = currentLabels.filter(label => label !== 'in-progress').concat('completed');
            
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issueNumber,
              labels: newLabels
            });
            
            const finalComment = `Deployment Completed Successfully
            
            Rollback artifact details:
            - Artifact Name: ${artifactName}
            - Retention: 30 days
            - SHA256 Checksum: ${sha256Checksum}`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: finalComment
            });
            
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issueNumber,
              state: 'closed'
            });
